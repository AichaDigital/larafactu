# Larafactu Installer - Docker Testing Environment
# 
# Ports configured to avoid conflicts with common services:
# - 8888: Installer web (avoiding 80, 8080)
# - 3307: MySQL (avoiding 3306 local)
# - NOT using 9200, 9300 (Elasticsearch)
#
# Usage:
#   docker-compose up -d
#   docker-compose exec php-fpm php vendor/bin/phpunit
#   docker-compose down -v

services:
  # PHP-FPM for installer
  php-fpm:
    image: abkrim/laravel-dock:8.4
    working_dir: /var/www/installer
    volumes:
      - ../:/var/www/installer:cached
      - ../../:/var/www/larafactu:cached
    environment:
      - PHP_VERSION=8.4
      - INSTALLER_ENV=testing
      - LARAFACTU_ROOT=/var/www/larafactu
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - installer-network

  # Nginx web server
  nginx:
    image: nginx:alpine
    ports:
      - "8888:80"  # Installer accessible at http://localhost:8888
    volumes:
      - ../:/var/www/installer:cached
      - ../../:/var/www/larafactu:cached
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - php-fpm
    networks:
      - installer-network

  # MySQL for testing
  mysql:
    image: mysql:8.0
    ports:
      - "3307:3306"  # Accessible at localhost:3307
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: larafactu_test
      MYSQL_USER: larafactu
      MYSQL_PASSWORD: larafactu
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - installer-network

volumes:
  mysql-data:
    driver: local

networks:
  installer-network:
    driver: bridge

