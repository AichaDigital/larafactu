# Larafactu - Instrucciones de Proyecto

## Descripcion del Proyecto

Larafactu es una aplicacion de facturacion electronica para el mercado espanol, construida sobre Laravel 12 con un ecosistema de paquetes propios.

## Stack Tecnologico

- **Backend**: Laravel 12 + Livewire 3
- **Frontend**: TailwindCSS 4 + DaisyUI 5 + Alpine.js
- **Base de datos**: MySQL (SQLite para tests)
- **Testing**: Pest
- **NO usar**: Filament (ABANDONADO - ver ADR-005), Laravel Volt

## Estructura de Paquetes

| Paquete | Descripcion | Estado |
|---------|-------------|--------|
| larabill | Core de facturacion | ACTIVO |
| lara-verifactu | Integracion AEAT Verifactu | ACTIVO |
| laratickets | Sistema de tickets | ACTIVO |
| lararoi | Verificacion VAT/ROI EU | ACTIVO |
| lara-content | CMS: paginas, posts, bloques, menus | EN DESARROLLO |
| *-filament | Paquetes Filament | ABANDONADOS |

**Ubicacion de paquetes**:

- Desarrollo: `/Users/abkrim/development/packages/aichadigital/`
- Symlinks en proyecto: `/Users/abkrim/SitesLR12/larafactu/packages/aichadigital/`

## ADRs

| ADR | Título | Estado |
|-----|--------|--------|
| ADR-001 | CompanyFiscalConfig | VIGENTE |
| ADR-002 | UUID v7 string para IDs | VIGENTE |
| ADR-003 | Unificación Users/Customers | SUPERSEDED por ADR-004 |
| ADR-004 | Sistema de Autorización | VIGENTE (authorization en app, no en paquetes) |
| ADR-005 | Deprecación Filament, adopción DaisyUI | VIGENTE |
| ADR-006 | Consolidación estado actual | VIGENTE |

**Ubicación**: `docs/architecture/`

## Reglas de Trabajo con Paquetes

### Dependencias de Schema (CRITICO)

Antes de trabajar con migraciones o modelos User, SIEMPRE leer:

- `packages/aichadigital/larabill/SCHEMA_REQUIREMENTS.md`

Este archivo define las columnas que larafactu DEBE tener en su tabla `users` para que larabill funcione. Incluye:

- `current_tax_profile_id` (ADR-004) - FK a user_tax_profiles
- `parent_user_id` (ADR-003) - Self-reference para delegacion
- `relationship_type` (ADR-003) - Tipo de relacion

Si hay errores de "column not found" relacionados con users, verificar primero este archivo.

### Migraciones en Paquetes (CRITICO)

**Patron obligatorio**: Ver `docs/internal/PACKAGE_DEVELOPMENT_STANDARDS.md`

- Usar archivos `.php` con timestamps (NO `.stub`)
- Usar `loadMigrationsFrom()` en ServiceProvider (NO `hasMigration()`)
- Usar `MigrationHelper::userIdColumn()` para FKs a users
- Referencia: larabill es la implementacion de referencia

### Migraciones en larafactu

- JAMAS ejecutar `php artisan migrate` sin permiso explicito
- JAMAS editar migraciones existentes publicadas
- Verificar SCHEMA_REQUIREMENTS.md del paquete antes de crear migraciones

### Testing

- Ejecutar tests de paquetes EN el directorio del paquete:

```bash
cd /Users/abkrim/SitesLR12/larafactu/packages/aichadigital/larabill
php vendor/bin/pest
```

- Ejecutar tests de larafactu EN larafactu:

```bash
cd /Users/abkrim/SitesLR12/larafactu
php vendor/bin/pest
```

### Enums y Base de Datos

- JAMAS usar tipo ENUM en MySQL
- Usar PHP Enum + unsignedTinyInteger en BD
- Cast en modelo: `protected $casts = ['field' => MyEnum::class];`

## Temas DaisyUI Configurados

| Rol | Tema |
|-----|------|
| Light default | cupcake |
| Dark default | abyss |
| Light alt | corporate |
| Dark alt | sunset |

Ver `docs/themes/daisyui-themes.md` para detalles.

## Estado del Trabajo

Ver `docs/WORK.md` para el estado actual del proyecto (tareas en progreso, completadas, pendientes).

## Comandos Frecuentes

```bash
# Lint
composer pint

# Analisis estatico
composer phpstan

# Tests
composer test

# Tests con coverage
composer test-coverage

# Calidad completa
composer quality
```

## Herramientas MCP - USO OBLIGATORIO

### Laravel Boost (mcp__laravel-boost)

**SIEMPRE usar para diagnostico de errores web**. Esta herramienta:

- Captura errores y logs automaticamente
- Consume recursos significativos
- Si no se usa, se desactiva

Herramientas principales:

- `last-error`: Ver ultimo error/excepcion
- `read-log-entries`: Leer logs de aplicacion
- `browser-logs`: Ver errores de frontend/JS
- `database-query`: Consultas SQL de diagnostico
- `tinker`: Ejecutar codigo PHP en contexto Laravel

### DaisyUI Blueprint (mcp__daisyui-blueprint)

**SIEMPRE usar para componentes UI**. Proporciona:

- Snippets de componentes DaisyUI correctos
- Ejemplos de uso semantico
- Patrones de diseño

Ademas, los ejemplos del template Nexus estan en:

- `docs/themes/nexus/` - HTML de referencia para tipografias y formas

## Notas Importantes

1. **NO crear archivos de documentacion** salvo que se pidan explicitamente
2. **NO añadir "Generated by Claude"** en commits
3. **Preferir edicion sobre creacion** de archivos
4. **Los paquetes son agnosticos** - no deben depender de la aplicacion
5. **La autorizacion va en la aplicacion**, no en paquetes
6. **Usar MCP laravel-boost** para diagnostico de errores web
7. **Usar MCP daisyui-blueprint** para componentes UI
8. **Actualizar docs afectados**: Cuando hay cambios que afectan a documentacion existente (guias, estrategias, ADRs), esta DEBE ser revisada y actualizada
