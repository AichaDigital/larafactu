---
description: "Larafactu Project - Staging for Billing Packages Development"
globs: ["**/*.php", "**/*.blade.php", "**/*.md"]
alwaysApply: true
---

# Larafactu - Staging Project Rules

## ğŸ¯ Project Identity

### Core Purpose
- **Staging environment** for testing billing packages in real-world scenarios
- **Target v1.0**: Hosting companies, Spain/EU, Intracom Operator
- **Critical deadline**: December 15, 2025 - stable version for WHMCS migration
- **Philosophy**: Pragmatic, Laravel-aligned, avoid over-engineering

### Main Packages Under Development
Located at: `/Users/abkrim/development/packages/aichadigital/`

1. **larabill** (core billing) - dev-main
2. **lararoi** (EU VAT/ROI logic) - dev-main
3. **lara-verifactu** (Spain AEAT integration) - dev-main
4. **laratickets** (support tickets) - dev-main
5. **lara100** (base-100 monetary) - v1.0 stable

## ğŸ—ï¸ Technical Stack

### Framework & Versions
- **PHP**: 8.4.13
- **Laravel**: 12.x
- **Filament**: 4.x
- **Pest**: 4.x (browser testing enabled)
- **Tailwind CSS**: 4.x
- **Database**: MySQL (local: Laravel Herd)

### UUID Strategy - String UUID v7

**IMPORTANTE**: Usamos UUID v7 **STRING** (char 36), NO binary.

#### ImplementaciÃ³n

```php
// Model con UUID
use AichaDigital\Larabill\Concerns\HasUuid;

class User extends Authenticatable
{
    use HasUuid;
    // NO necesita $incrementing ni $keyType - el trait lo maneja
}
```

#### Migraciones

```php
// UUID string (36 chars)
$table->uuid('id')->primary();
$table->uuid('user_id');  // FK a users

// Para relaciones
$table->foreignUuid('user_id')->constrained()->cascadeOnDelete();
```

**Modelos con UUID**: User, Invoice, Ticket
**Modelos con Integer ID**: TaxRate, CompanyFiscalConfig, CustomerFiscalData, UnitMeasure

## ğŸ’° Monetary Values - Base 100 (Lara100)

### CRITICAL RULE
**NEVER use float/decimal for monetary values, prices, amounts, tax rates**

### Always Use Integers (Base 100)
- â‚¬12.34 â†’ `1234` (integer)
- 21.5% IVA â†’ `2150` (integer)
- â‚¬0.99 â†’ `99` (integer)

### Package
- `aichadigital/lara100` (v1.0 - stable)
- Prevents floating-point errors
- Ensures exact fiscal calculations

## ğŸ“¦ Package Development Mode

### Local Development Setup

**CRITICAL**: Larafactu usa **path repositories con symlinks** para desarrollo local.

```
/Users/abkrim/
â”œâ”€â”€ development/packages/aichadigital/  # Paquetes SOURCE
â”‚   â”œâ”€â”€ larabill/
â”‚   â”œâ”€â”€ lararoi/
â”‚   â”œâ”€â”€ lara-verifactu/
â”‚   â””â”€â”€ laratickets/
â””â”€â”€ SitesLR12/larafactu/                # App STAGING
    â””â”€â”€ packages/aichadigital/          # Symlinks
```

### Workflow de Desarrollo

Ver `docs/WORKFLOW.md` para flujo completo.

**Resumen**:
1. Editar en `packages/aichadigital/` (symlinks)
2. Cambios reflejados inmediatamente
3. Commit SEPARADO: primero paquete, luego app
4. `composer update aichadigital/*` despuÃ©s de commits en paquetes

## ğŸ§ª Testing Standards

### Coverage Goals (Pragmatic)
- **Packages**: 80-95% coverage
- **Staging app**: 60-70% coverage
- **Priority**: Feature tests > Unit tests

### Comandos

```bash
php artisan test                    # Todos los tests
php artisan test --filter=Invoice   # Filtrar
vendor/bin/pint --dirty             # Formatear
```

## ğŸ“š GestiÃ³n de DocumentaciÃ³n

### Estructura de docs/

```
docs/
â”œâ”€â”€ ADR_*.md              # Decisiones arquitectÃ³nicas (permanentes)
â”œâ”€â”€ PRODUCTION_*.md       # GuÃ­as de producciÃ³n (permanentes)
â”œâ”€â”€ DEVELOPMENT_*.md      # GuÃ­as de desarrollo (permanentes)
â”œâ”€â”€ WORKFLOW.md           # Flujo de trabajo (permanente)
â””â”€â”€ in-progress/          # Temporales (limpiar regularmente)
```

### Reglas CRÃTICAS

**PERMITIDO**:
- âœ… ADR_XXX_*.md (decisiones arquitectÃ³nicas)
- âœ… GuÃ­as de producciÃ³n/desarrollo
- âœ… WORKFLOW.md

**PROHIBIDO** (NO COMMITEAR):
- âŒ HOTFIX_*.md â†’ aplicar y eliminar
- âŒ BUG_*.md â†’ resolver y eliminar
- âŒ RESUMEN_*.md â†’ no commitear
- âŒ SESION_*.md â†’ no commitear
- âŒ Documentos de versiones antiguas

## ğŸš« Anti-Patterns (Critical)

### DON'T Do This
âŒ Over-engineer for hypothetical scenarios
âŒ Use float/decimal for money (always base100)
âŒ Bypass Laravel conventions
âŒ Create complex abstractions "just in case"
âŒ Commitear documentos temporales/obsoletos

### DO This Instead
âœ… Follow Laravel 12 conventions strictly
âœ… Test in staging before package commits
âœ… Document breaking changes in CHANGELOG
âœ… Prioritize delivery over perfection
âœ… Limpiar docs/ regularmente

## ğŸ”§ Arquitectura Fiscal (ADR-001)

### Modelos Principales

```
CompanyFiscalConfig    â†’ ConfiguraciÃ³n fiscal empresa (temporal)
CustomerFiscalData     â†’ Datos fiscales cliente (histÃ³rico)
Invoice                â†’ Factura (inmutable una vez emitida)
```

### Validez Temporal

- `valid_from`: Inicio de vigencia
- `valid_until`: Fin de vigencia (null = actual)
- Facturas capturan snapshot al crearse

## ğŸ“Œ Quick Reference

**UUID Models**: User, Invoice, Ticket (string UUID v7)
**Integer Models**: TaxRate, CompanyFiscalConfig, CustomerFiscalData
**Money Format**: Always base 100 integers (lara100)
**Package Mode**: All in `dev-main` with symlinks
**Deadline**: December 15, 2025 (v1.0 stable)
**Target**: Hosting + Spain + Intracom + WHMCS migration

---

**Remember**: Pragmatism and delivery speed are priorities. Over-engineering is the enemy. Laravel conventions are the guide. Keep docs/ clean.
